---
export const prerender = false;
import Layout from "@/layouts/Layout.astro";
import { ProductService } from "@/services/productService";
import ProductGallery from "@/components/catalog/ProductGallery.vue";
import ProductCard from "@/components/catalog/ProductCard.astro";

const { id } = Astro.params;
const product = await ProductService.findById(id!);

if (!product) {
	return Astro.redirect("/404");
}

if (product.status === 'inactive') {
	return Astro.redirect("/catalog");
}

const canPurchase = product.status === 'active';
const statusConfig: Record<string, { label: string; color: string }> = {
	out_of_stock: { label: 'Agotado', color: 'bg-red-500' },
	paused: { label: 'Pausado', color: 'bg-amber-500' }
};
const showStatusBadge = product.status === 'out_of_stock' || product.status === 'paused';

// Fetch suggested products (same category, different ID, only active)
const { products: suggested } = await ProductService.getAll({
	limit: 4,
	categoryId: String(product.category_id),
});

const filteredSuggested = suggested.filter((p) => p.id !== product.id && p.status === 'active');

const formattedPrice =
	`$ ` +
	new Intl.NumberFormat("es-AR", {
		maximumFractionDigits: 0,
	}).format(product.price);

const seoDescription = product.description
	? product.description.substring(0, 155).replace(/\n/g, " ").trim() + (product.description.length > 155 ? "..." : "")
	: `${product.title} - Réplica oficial CAT a escala. ${product.category_name || "Modelo coleccionable"}. Comprá online en Cat By Cam con envío a todo el país.`;

const seoImage = product.main_image || undefined;
---

<Layout
	title={product.title}
	description={seoDescription}
	image={seoImage}
>
	<div class="bg-accent/10 pt-32 pb-24">
		<div class="container-custom">
			<!-- Breadcrumbs -->
			<nav
				class="flex items-center gap-2 text-[10px] font-black uppercase tracking-widest text-secondary/30 mb-12"
			>
				<a href="/" class="hover:text-primary transition-colors"
					>Inicio</a
				>
				<span>/</span>
				<a href="/catalog" class="hover:text-primary transition-colors"
					>Catálogo</a
				>
				<span>/</span>
				<span class="text-secondary/60">{product.category_name}</span>
			</nav>

			<div class="grid grid-cols-1 lg:grid-cols-12 gap-16">
				<!-- Left: Gallery -->
				<div class="lg:col-span-7">
					<ProductGallery
						client:load
						mainImage={product.main_image}
						mainImageFull={product.main_image_full}
						mainImageWidth={product.main_image_width}
						mainImageHeight={product.main_image_height}
						images={product.images || []}
					/>
				</div>

				<!-- Right: Info -->
				<div class="lg:col-span-5">
					<div
						class="bg-white p-10 rounded-[2.5rem] border border-secondary/5 shadow-sm sticky top-32"
					>
						<div class="flex items-center gap-3 mb-6">
							<span
								class="inline-block px-4 py-1 bg-primary/5 text-primary text-[10px] font-black uppercase tracking-widest rounded-full italic"
							>
								{
									product.item_condition === "new"
										? "Nuevo Ingreso"
										: "Usado Seleccionado"
								}
							</span>
							{showStatusBadge && statusConfig[product.status] && (
								<span
									class={`inline-block px-4 py-1 text-white text-[10px] font-black uppercase tracking-widest rounded-full ${statusConfig[product.status].color}`}
								>
									{statusConfig[product.status].label}
								</span>
							)}
						</div>

						<h1
							class="text-4xl font-black text-secondary leading-tight mb-4"
						>
							{product.title}
						</h1>

						<p class="text-secondary/60 text-sm font-medium mb-8">
							Ref: #CBC-{product.id?.toString().padStart(4, "0")}
						</p>

						<div class="flex items-baseline gap-2 mb-10">
							<span
								class="text-5xl font-black text-secondary tracking-tighter"
							>
								{formattedPrice}
							</span>
							<span
								class="text-secondary/30 font-bold text-sm uppercase"
								>Stock: {
									product.stock > 0
										? product.stock
										: "Consultar"
								}</span
							>
						</div>

						<div class="space-y-4 mb-10">
							<a
								href={`https://wa.me/5491100000000?text=Hola! Estoy interesado en el producto: ${product.title} (Ref: ${product.id})`}
								target="_blank"
								class="w-full bg-primary hover:bg-secondary text-white font-black py-6 rounded-2xl flex items-center justify-center gap-3 transition-all shadow-xl shadow-primary/20 hover:-translate-y-1 active:translate-y-0"
							>
								<svg
									xmlns="http://www.w3.org/2000/svg"
									width="20"
									height="20"
									viewBox="0 0 24 24"
									fill="none"
									stroke="currentColor"
									stroke-width="3"
									stroke-linecap="round"
									stroke-linejoin="round"
									><path
										d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"
									></path></svg
								>
								Consultar por WhatsApp
							</a>
							{canPurchase ? (
								<button
									id="buy-now-btn"
									class="w-full bg-accent/50 hover:bg-accent text-secondary font-black py-6 rounded-2xl transition-all cursor-pointer"
									data-product={JSON.stringify({
										id: product.id,
										title: product.title,
										category: product.category_name,
										image: product.main_image,
										price: product.price,
									})}
								>
									Comprar Ahora
								</button>
							) : (
								<div class="w-full bg-secondary/10 text-secondary/50 font-black py-6 rounded-2xl text-center cursor-not-allowed">
									{product.status === 'out_of_stock' ? 'Producto Agotado' : 'No Disponible'}
								</div>
							)}
						</div>

						<div
							class="pt-10 border-t border-secondary/5 space-y-6"
						>
							<div class="flex gap-4">
								<div
									class="w-10 h-10 bg-green-500/5 rounded-xl flex items-center justify-center text-green-600 shrink-0"
								>
									<svg
										xmlns="http://www.w3.org/2000/svg"
										width="20"
										height="20"
										viewBox="0 0 24 24"
										fill="none"
										stroke="currentColor"
										stroke-width="2.5"
										stroke-linecap="round"
										stroke-linejoin="round"
										><rect
											width="18"
											height="10"
											x="3"
											y="11"
											rx="2"></rect><circle
											cx="12"
											cy="5"
											r="2"></circle><path d="M12 7v4"
										></path><path d="M4.5 15.5h15"
										></path></svg
									>
								</div>
								<div>
									<h4 class="text-sm font-black italic">
										Envío a todo el país
									</h4>
									<p class="text-secondary/40 text-xs">
										Logística especializada para maquinaria
										pesada.
									</p>
								</div>
							</div>
							<div class="flex gap-4">
								<div
									class="w-10 h-10 bg-primary/5 rounded-xl flex items-center justify-center text-primary shrink-0"
								>
									<svg
										xmlns="http://www.w3.org/2000/svg"
										width="20"
										height="20"
										viewBox="0 0 24 24"
										fill="none"
										stroke="currentColor"
										stroke-width="2.5"
										stroke-linecap="round"
										stroke-linejoin="round"
										><path
											d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"
										></path></svg
									>
								</div>
								<div>
									<h4 class="text-sm font-black italic">
										Garantía Cat By Cam
									</h4>
									<p class="text-secondary/40 text-xs">
										Todos nuestros productos cuentan con
										respaldo técnico.
									</p>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Tabs/Description -->
			<div class="mt-24">
				<div class="flex border-b border-secondary/5 mb-12">
					<button
						class="px-8 py-4 border-b-4 border-primary text-secondary font-black italic uppercase tracking-widest text-xs"
						>Descripción Detallada</button
					>
				</div>
				<div class="prose prose-lg max-w-none text-secondary/70">
					{
						product.description
							.split("\n")
							.map((line) => <p>{line}</p>)
					}
				</div>
			</div>
		</div>
	</div>

	<!-- Suggestions -->
	{
		filteredSuggested.length > 0 && (
			<section class="section-padding bg-white border-t border-secondary/5">
				<div class="container-custom">
					<div class="flex items-end justify-between mb-16">
						<div>
							<h2 class="text-4xl font-black italic mb-4">
								Sugerencias
							</h2>
							<p class="text-secondary/40 font-medium">
								Equipos similares dentro de la categoría{" "}
								<span class="text-primary font-bold">
									{product.category_name}
								</span>
							</p>
						</div>
						<a
							href="/catalog"
							class="text-primary font-black uppercase tracking-widest text-xs hover:underline"
						>
							Ver todo el catálogo
						</a>
					</div>

					<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
						{filteredSuggested.map((p) => (
							<ProductCard
								id={p.id!}
								title={p.title}
								category={p.category_name || "Sin categoría"}
								image={p.main_image}
								price={p.price}
							/>
						))}
					</div>
				</div>
			</section>
		)
	}
</Layout>

<script>
	import { addItem } from "@/stores/cartStore";

	const buyNowBtn = document.getElementById("buy-now-btn");

	if (buyNowBtn) {
		buyNowBtn.addEventListener("click", () => {
			const productData = buyNowBtn.getAttribute("data-product");
			if (productData) {
				const product = JSON.parse(productData);
				addItem(product);
				window.location.href = "/cart";
			}
		});
	}
</script>
