---
export const prerender = false;
import { auth } from "@/lib/auth";

if (Astro.request.method === "POST") {
	try {
		const response = await auth.api.signOut({
			headers: Astro.request.headers,
			asResponse: true,
		});

		// Propagar Set-Cookie headers de better-auth (incluye __Secure- prefix en HTTPS)
		const setCookies = response.headers.getSetCookie?.() || [];
		const redirectResponse = Astro.redirect("/login");
		for (const cookie of setCookies) {
			redirectResponse.headers.append("Set-Cookie", cookie);
		}
		return redirectResponse;
	} catch (e) {
		// Si falla, borrar cookies manualmente (ambas variantes)
		Astro.cookies.delete("better-auth.session_token", { path: "/" });
		Astro.cookies.delete("better-auth.session_data", { path: "/" });
		Astro.cookies.delete("__Secure-better-auth.session_token", { path: "/", secure: true });
		Astro.cookies.delete("__Secure-better-auth.session_data", { path: "/", secure: true });
	}
}

return Astro.redirect("/login");
---
