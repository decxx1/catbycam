---
export const prerender = false;
import AdminLayout from "@/layouts/admin.astro";
import pool from "@/utils/db";
import AdminPageHeader from "@/components/admin/common/AdminPageHeader.astro";
import StatCard from "@/components/admin/dashboard/StatCard.astro";
import LatestUsersTable from "@/components/admin/dashboard/LatestUsersTable.astro";
import { getSession } from "@/utils/auth";
import { UserService } from "@/services/userService";

// Validar sesión ANTES de cualquier query
const token = Astro.cookies.get("auth_token")?.value;
const session = token ? await getSession(token) : null;

if (!session) {
	if (token) {
		Astro.cookies.delete("auth_token", { path: "/" });
	}
	return Astro.redirect("/admin/login");
}

const user = await UserService.findById(session.userId);
if (!user || user.role !== "admin") {
	Astro.cookies.delete("auth_token", { path: "/" });
	return Astro.redirect("/");
}

// Ahora sí ejecutar queries
let totalUsers = 0;
let latestUsers: any[] = [];

try {
	const [userCountResult]: any = await pool.execute(
		"SELECT COUNT(*) as total FROM users WHERE role != 'admin'",
	);
	totalUsers = userCountResult[0].total;

	const [usersResult]: any = await pool.execute(
		"SELECT name, email, created_at FROM users WHERE role != 'admin' ORDER BY created_at DESC LIMIT 5",
	);
	latestUsers = usersResult;
} catch (error) {
	console.error("Dashboard DB error:", error);
}

const usersIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`;
---

<AdminLayout title="Dashboard">
	<AdminPageHeader title="Dashboard" />

	<div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
		<StatCard
			label="Usuarios Registrados"
			value={totalUsers}
			trend="+12% este mes"
			icon={usersIcon}
		/>

		<!-- More stat cards would go here -->
	</div>

	<LatestUsersTable users={latestUsers} />
</AdminLayout>
