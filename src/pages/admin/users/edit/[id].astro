---
export const prerender = false;
import AdminLayout from "@/layouts/admin.astro";
import { UserService } from "@/services/userService";
import { requireAdmin } from "@/utils/adminAuth";

const auth = await requireAdmin(Astro.cookies);
if ('redirect' in auth) return Astro.redirect(auth.redirect);
const { user: currentUser } = auth;

const { id } = Astro.params;

if (!id) return Astro.redirect("/admin/users");

const user = await UserService.findById(id);

if (!user) return Astro.redirect("/admin/users");

let error = "";
let success = "";

if (Astro.request.method === "POST") {
	try {
		const formData = await Astro.request.formData();
		const name = formData.get("name")?.toString();
		const email = formData.get("email")?.toString();
		const role = formData.get("role")?.toString() as "user" | "admin";

		if (name && email && role) {
			await UserService.updateUser(id, { name, email, role });
			success = "Usuario actualizado correctamente.";
			// Refresh local user data for display
			user.name = name;
			user.email = email;
			user.role = role;
		} else {
			error = "Todos los campos son obligatorios.";
		}
	} catch (e) {
		error = "Error al actualizar el usuario.";
		console.error(e);
	}
}
---

<AdminLayout title={`Editar Usuario: ${user.name}`} user={currentUser}>
	<div class="max-w-2xl mx-auto mt-12">
		<div class="flex items-center gap-4 mb-12">
			<a
				href="/admin/users"
				class="w-10 h-10 flex items-center justify-center bg-white border border-secondary/5 rounded-xl text-secondary hover:text-primary transition-colors shadow-sm cursor-pointer group"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					width="20"
					height="20"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2.5"
					stroke-linecap="round"
					stroke-linejoin="round"
					class="transition-transform group-hover:-translate-x-1"
					><path d="m15 18-6-6 6-6"></path></svg
				>
			</a>
			<div>
				<h1 class="text-3xl font-black">Editar Usuario</h1>
				<p class="text-secondary/50 text-sm mt-1">
					ID: #{user.id} • Miembro desde {
						new Date(user.created_at).toLocaleDateString()
					}
				</p>
			</div>
		</div>

		{
			error && (
				<div class="mb-8 p-4 bg-primary/10 border border-primary/20 rounded-xl text-primary text-sm font-bold text-center">
					{error}
				</div>
			)
		}

		{
			success && (
				<div class="mb-8 p-4 bg-green-500/10 border border-green-500/20 rounded-xl text-green-600 text-sm font-bold text-center">
					{success}
				</div>
			)
		}

		<div
			class="bg-white rounded-3xl p-8 md:p-12 border border-secondary/5 shadow-xl shadow-secondary/5"
		>
			<form method="POST" class="space-y-8">
				<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
					<div class="flex flex-col gap-2">
						<label
							class="text-[10px] uppercase font-bold tracking-widest text-secondary/40 ml-1"
							>Nombre Completo</label
						>
						<input
							name="name"
							type="text"
							required
							value={user.name}
							class="w-full bg-accent/50 border border-secondary/10 rounded-xl px-5 py-4 focus:outline-none focus:border-primary/40 focus:bg-white transition-all font-bold"
						/>
					</div>

					<div class="flex flex-col gap-2">
						<label
							class="text-[10px] uppercase font-bold tracking-widest text-secondary/40 ml-1"
							>Rol de Usuario</label
						>
						<div class="relative">
							<select
								name="role"
								class="w-full bg-accent/50 border border-secondary/10 rounded-xl px-5 py-4 focus:outline-none focus:border-primary/40 focus:bg-white transition-all font-bold appearance-none cursor-pointer"
							>
								<option
									value="user"
									selected={user.role === "user"}
									>Usuario Estándar</option
								>
								<option
									value="admin"
									selected={user.role === "admin"}
									>Administrador</option
								>
							</select>
							<svg
								xmlns="http://www.w3.org/2000/svg"
								width="16"
								height="16"
								viewBox="0 0 24 24"
								fill="none"
								stroke="currentColor"
								stroke-width="2.5"
								stroke-linecap="round"
								stroke-linejoin="round"
								class="absolute right-4 top-5 pointer-events-none text-secondary/40"
								><path d="m6 9 6 6 6-6"></path></svg
							>
						</div>
					</div>
				</div>

				<div class="flex flex-col gap-2">
					<label
						class="text-[10px] uppercase font-bold tracking-widest text-secondary/40 ml-1"
						>Correo Electrónico</label
					>
					<input
						name="email"
						type="email"
						required
						value={user.email}
						class="w-full bg-accent/50 border border-secondary/10 rounded-xl px-5 py-4 focus:outline-none focus:border-primary/40 focus:bg-white transition-all font-bold"
					/>
				</div>

				<div
					class="pt-4 border-t border-secondary/5 flex items-center gap-4"
				>
					<button
						type="submit"
						class="grow btn-primary py-5 text-lg shadow-2xl shadow-primary/30"
					>
						Guardar Cambios
					</button>
					<a
						href="/admin/users"
						class="px-8 py-5 text-secondary/40 font-bold uppercase tracking-widest text-xs hover:text-secondary transition-colors"
					>
						Descartar
					</a>
				</div>
			</form>
		</div>

		<div
			class="mt-8 p-6 bg-accent/30 rounded-2xl flex items-center gap-4 border border-secondary/5"
		>
			<div
				class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-secondary/20 shadow-sm"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					width="20"
					height="20"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2.5"
					stroke-linecap="round"
					stroke-linejoin="round"
					><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"
					></path></svg
				>
			</div>
			<p class="text-xs text-secondary/40 leading-relaxed font-medium">
				Al cambiar el rol de un usuario, sus permisos en la plataforma
				se actualizarán de forma inmediata en su próxima navegación.
			</p>
		</div>
	</div>
</AdminLayout>
