---
import AdminLayout from "@/layouts/admin.astro";
import { UserService } from "@/services/userService";
import { getSession } from "@/utils/auth";

const token = Astro.cookies.get("auth_token")?.value;
const session = token ? await getSession(token) : null;
const currentUser = session ? await UserService.findById(session.userId) : null;

const users = await UserService.getAllUsers();
---

<AdminLayout title="Gestión de Usuarios">
	<div class="flex items-center justify-between mb-8">
		<div>
			<h1 class="text-3xl font-black">Usuarios</h1>
			<p class="text-secondary/50 text-sm mt-1">
				Gestiona todos los usuarios registrados en la plataforma.
			</p>
		</div>
		<div class="flex items-center gap-4">
			<div class="relative">
				<input
					id="user-search"
					type="text"
					placeholder="Buscar usuario..."
					class="bg-white border border-secondary/5 rounded-xl pl-10 pr-4 py-2 text-sm focus:outline-none focus:border-primary/40 focus:ring-4 focus:ring-primary/5 transition-all w-64 shadow-sm"
				/>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					width="16"
					height="16"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2.5"
					class="absolute left-3 top-2.5 text-secondary/30"
					><circle cx="11" cy="11" r="8"></circle><path
						d="m21 21-4.3-4.3"></path></svg
				>
			</div>
			<!-- Add User Button if needed -->
		</div>
	</div>

	<div
		class="bg-white rounded-3xl border border-secondary/5 shadow-sm overflow-hidden"
	>
		<table class="w-full text-left">
			<thead>
				<tr class="bg-accent/5">
					<th
						class="px-8 py-4 text-[10px] font-bold uppercase tracking-widest text-secondary/40"
						>ID</th
					>
					<th
						class="px-8 py-4 text-[10px] font-bold uppercase tracking-widest text-secondary/40"
						>Nombre</th
					>
					<th
						class="px-8 py-4 text-[10px] font-bold uppercase tracking-widest text-secondary/40"
						>Email</th
					>
					<th
						class="px-8 py-4 text-[10px] font-bold uppercase tracking-widest text-secondary/40"
						>Rol</th
					>
					<th
						class="px-8 py-4 text-[10px] font-bold uppercase tracking-widest text-secondary/40"
						>Registro</th
					>
					<th
						class="px-8 py-4 text-[10px] font-bold uppercase tracking-widest text-secondary/40 text-right"
						>Acciones</th
					>
				</tr>
			</thead>
			<tbody class="divide-y divide-secondary/5">
				{
					users.map((user) => (
						<tr
							class="user-row hover:bg-accent/5 transition-colors group"
							data-name={user.name.toLowerCase()}
							data-email={user.email.toLowerCase()}
						>
							<td class="px-8 py-5 text-sm text-secondary/40 font-mono">
								#{user.id}
							</td>
							<td class="px-8 py-5">
								<div class="flex items-center gap-3">
									<div class="w-8 h-8 rounded-lg bg-secondary text-white flex items-center justify-center text-[10px] font-black shrink-0">
										{user.name.charAt(0).toUpperCase()}
									</div>
									<span class="font-bold text-sm text-secondary tracking-tight">
										{user.name}
									</span>
								</div>
							</td>
							<td class="px-8 py-5 text-sm text-secondary/60">
								{user.email}
							</td>
							<td class="px-8 py-5">
								<span
									class={`text-[10px] font-bold uppercase tracking-widest px-2 py-1 rounded-full border ${
										user.role === "admin"
											? "bg-primary/5 text-primary border-primary/10"
											: "bg-green-500/5 text-green-600 border-green-500/10"
									}`}
								>
									{user.role}
								</span>
							</td>
							<td class="px-8 py-5 text-sm text-secondary/40">
								{new Date(user.created_at).toLocaleDateString()}
							</td>
							<td class="px-8 py-5 text-right">
								<div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
									<a
										href={`/admin/users/edit/${user.id}`}
										class="w-8 h-8 flex items-center justify-center rounded-lg bg-accent/50 text-secondary hover:bg-secondary hover:text-white transition-all shadow-sm"
										title="Editar"
									>
										<svg
											xmlns="http://www.w3.org/2000/svg"
											width="14"
											height="14"
											viewBox="0 0 24 24"
											fill="none"
											stroke="currentColor"
											stroke-width="2.5"
											stroke-linecap="round"
											stroke-linejoin="round"
										>
											<>
												<path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" />
												<path d="m15 5 4 4" />
											</>
										</svg>
									</a>
									<button
										class={`delete-user-btn w-8 h-8 flex items-center justify-center rounded-lg shadow-sm transition-all ${
											user.id === currentUser?.id
												? "bg-secondary/5 text-secondary/20 cursor-not-allowed opacity-50"
												: "bg-primary/5 text-primary hover:bg-primary hover:text-white cursor-pointer"
										}`}
										data-id={user.id}
										data-name={user.name}
										disabled={user.id === currentUser?.id}
										title={
											user.id === currentUser?.id
												? "No puedes eliminarte a ti mismo"
												: "Eliminar"
										}
									>
										<svg
											xmlns="http://www.w3.org/2000/svg"
											width="14"
											height="14"
											viewBox="0 0 24 24"
											fill="none"
											stroke="currentColor"
											stroke-width="2.5"
											stroke-linecap="round"
											stroke-linejoin="round"
										>
											<>
												<path d="M3 6h18" />
												<path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
												<path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
												<line
													x1="10"
													y1="11"
													x2="10"
													y2="17"
												/>
												<line
													x1="14"
													y1="11"
													x2="14"
													y2="17"
												/>
											</>
										</svg>
									</button>
								</div>
							</td>
						</tr>
					))
				}
			</tbody>
		</table>
	</div>

	<!-- Delete Confirmation Modal (Native HTML/Custom) -->
	<div id="delete-modal" class="fixed inset-0 z-[100] hidden">
		<div class="absolute inset-0 bg-secondary/60 backdrop-blur-sm"></div>
		<div class="absolute inset-0 flex items-center justify-center p-4">
			<div
				class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-8 animate-in fade-in zoom-in duration-300"
			>
				<div
					class="w-16 h-16 bg-primary/10 rounded-2xl flex items-center justify-center text-primary mb-6"
				>
					<svg
						xmlns="http://www.w3.org/2000/svg"
						width="32"
						height="32"
						viewBox="0 0 24 24"
						fill="none"
						stroke="currentColor"
						stroke-width="2.5"
						stroke-linecap="round"
						stroke-linejoin="round"
						><path d="M3 6h18"></path><path
							d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"
						></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"
						></path><line x1="10" y1="11" x2="10" y2="17"
						></line><line x1="14" y1="11" x2="14" y2="17"
						></line></svg
					>
				</div>
				<h3 class="text-2xl font-black mb-2">¿Eliminar usuario?</h3>
				<p class="text-secondary/60 text-sm leading-relaxed mb-8">
					Estás por eliminar a <span
						id="delete-user-name"
						class="font-bold text-secondary"></span>. Esta acción no
					se puede deshacer y el usuario perderá acceso inmediato.
				</p>
				<div class="flex items-center gap-4">
					<button
						id="close-modal"
						class="flex-grow bg-accent/50 hover:bg-accent text-secondary font-bold py-4 rounded-xl transition-all cursor-pointer"
						>Cancelar</button
					>
					<form
						id="delete-form"
						method="POST"
						action="/admin/users/delete"
						class="flex-grow"
					>
						<input type="hidden" name="id" id="delete-user-id" />
						<button
							type="submit"
							class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-4 rounded-xl transition-all shadow-lg shadow-primary/20 cursor-pointer"
							>Eliminar</button
						>
					</form>
				</div>
			</div>
		</div>
	</div>
</AdminLayout>

<script>
	// Search functionality
	const searchInput = document.getElementById(
		"user-search",
	) as HTMLInputElement;
	const userRows = document.querySelectorAll(".user-row");

	searchInput?.addEventListener("input", (e) => {
		const query = (e.target as HTMLInputElement).value.toLowerCase();
		userRows.forEach((row) => {
			const name = row.getAttribute("data-name") || "";
			const email = row.getAttribute("data-email") || "";
			if (name.includes(query) || email.includes(query)) {
				(row as HTMLElement).style.display = "";
			} else {
				(row as HTMLElement).style.display = "none";
			}
		});
	});

	const modal = document.getElementById("delete-modal");
	const closeBtn = document.getElementById("close-modal");
	const deleteBtns = document.querySelectorAll(".delete-user-btn");
	const userNameSpan = document.getElementById("delete-user-name");
	const userIdInput = document.getElementById(
		"delete-user-id",
	) as HTMLInputElement;

	deleteBtns.forEach((btn) => {
		btn.addEventListener("click", () => {
			const id = btn.getAttribute("data-id");
			const name = btn.getAttribute("data-name");
			if (userNameSpan) userNameSpan.textContent = name;
			if (userIdInput) userIdInput.value = id || "";
			modal?.classList.remove("hidden");
		});
	});

	closeBtn?.addEventListener("click", () => {
		modal?.classList.add("hidden");
	});

	modal?.addEventListener("click", (e) => {
		if (e.target === modal.children[0]) {
			modal.classList.add("hidden");
		}
	});

	// Handle ESC key
	window.addEventListener("keydown", (e) => {
		if (e.key === "Escape" && !modal?.classList.contains("hidden")) {
			modal?.classList.add("hidden");
		}
	});
</script>
