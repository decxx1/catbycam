---
export const prerender = false;
import AdminLayout from "@/layouts/admin.astro";
import { UserService } from "@/services/userService";
import AdminPageHeader from "@/components/admin/common/AdminPageHeader.astro";
import UserTable from "@/components/admin/users/UserTable.astro";
import DeleteUserModal from "@/components/admin/users/DeleteUserModal.astro";
import { requireAdmin } from "@/utils/adminAuth";

const auth = await requireAdmin(Astro.cookies);
if ('redirect' in auth) return Astro.redirect(auth.redirect);
const { user: currentUser } = auth;

const users = await UserService.getAllUsers();
---

<AdminLayout title="GestiÃ³n de Usuarios" user={currentUser}>
	<AdminPageHeader
		title="Usuarios"
		subtitle="Gestiona todos los usuarios registrados en la plataforma."
	>
		<div slot="actions" class="relative">
			<input
				id="user-search"
				type="text"
				placeholder="Buscar usuario..."
				class="bg-white border border-secondary/5 rounded-xl pl-10 pr-4 py-2 text-sm focus:outline-none focus:border-primary/40 focus:ring-4 focus:ring-primary/5 transition-all w-64 shadow-sm"
			/>
			<svg
				xmlns="http://www.w3.org/2000/svg"
				width="16"
				height="16"
				viewBox="0 0 24 24"
				fill="none"
				stroke="currentColor"
				stroke-width="2.5"
				class="absolute left-3 top-2.5 text-secondary/30"
				><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"
				></path></svg
			>
		</div>
	</AdminPageHeader>

	<UserTable users={users} currentUserId={currentUser?.id} />

	<DeleteUserModal />
</AdminLayout>

<script>
	// Search functionality
	const searchInput = document.getElementById(
		"user-search",
	) as HTMLInputElement;
	const userRows = document.querySelectorAll(".user-row");

	searchInput?.addEventListener("input", (e) => {
		const query = (e.target as HTMLInputElement).value.toLowerCase();
		userRows.forEach((row) => {
			const name = row.getAttribute("data-name") || "";
			const email = row.getAttribute("data-email") || "";
			if (name.includes(query) || email.includes(query)) {
				(row as HTMLElement).style.display = "";
			} else {
				(row as HTMLElement).style.display = "none";
			}
		});
	});
</script>
