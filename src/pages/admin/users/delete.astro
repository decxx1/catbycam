---
import { UserService } from "@/services/userService";
import { getSession } from "@/utils/auth";

export const prerender = false;

const token = Astro.cookies.get("auth_token")?.value;
const session = token ? await getSession(token) : null;

if (!session) {
	return Astro.redirect("/admin/login");
}

const currentUser = await UserService.findById(session.userId);
if (!currentUser || currentUser.role !== "admin") {
	return Astro.redirect("/");
}

if (Astro.request.method === "POST") {
	const formData = await Astro.request.formData();
	const id = formData.get("id")?.toString();

	if (id) {
		// Prevent deleting yourself
		if (id === currentUser.id.toString()) {
			return Astro.redirect("/admin/users?error=self-delete");
		}

		await UserService.deleteUser(id);
	}
}

return Astro.redirect("/admin/users");
---
