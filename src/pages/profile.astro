---
import Layout from "@/layouts/Layout.astro";
import { getSession } from "@/utils/auth";
import { UserService } from "@/services/userService";

const token = Astro.cookies.get("auth_token")?.value;
const session = token ? await getSession(token) : null;

if (!session) {
	return Astro.redirect("/login");
}

const user = await UserService.findById(session.userId);

if (!user) {
	Astro.cookies.delete("auth_token");
	return Astro.redirect("/login");
}
---

<Layout title="Mi Perfil">
	<section class="min-h-screen pt-40 pb-20 bg-accent/20">
		<div class="container-custom">
			<div class="max-w-4xl mx-auto">
				<div class="flex flex-col md:flex-row gap-8 items-start mb-12">
					<div
						class="w-32 h-32 bg-primary rounded-3xl flex items-center justify-center text-white text-4xl font-black"
					>
						{user.name.charAt(0).toUpperCase()}
					</div>
					<div>
						<h1 class="text-4xl font-black mb-2">{user.name}</h1>
						<p class="text-secondary/60 font-medium">
							{user.email}
						</p>
						<span
							class="inline-block mt-4 bg-primary/10 text-primary text-[10px] font-bold uppercase tracking-widest px-3 py-1 rounded-full border border-primary/20"
						>
							{
								user.role === "admin"
									? "Administrador"
									: "Usuario"
							}
						</span>
					</div>
				</div>

				<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
					<!-- Account Stats -->
					<div
						class="bg-white p-8 rounded-3xl border border-secondary/5 shadow-xl shadow-secondary/5 col-span-1"
					>
						<h3
							class="font-bold text-sm uppercase tracking-widest text-secondary/40 mb-6"
						>
							Actividad
						</h3>
						<div class="space-y-6">
							<div>
								<span class="block text-2xl font-black">0</span>
								<span
									class="text-xs font-bold text-secondary/30 uppercase"
									>Pedidos realizados</span
								>
							</div>
							<div>
								<span class="block text-sm font-bold"
									>{
										new Date(
											user.created_at,
										).toLocaleDateString()
									}</span
								>
								<span
									class="text-xs font-bold text-secondary/30 uppercase"
									>Cliente desde</span
								>
							</div>
						</div>
					</div>

					<!-- Main Info -->
					<div
						class="bg-white p-8 rounded-3xl border border-secondary/5 shadow-xl shadow-secondary/5 md:col-span-2"
					>
						<div
							class="flex items-center justify-between mb-8 pb-4 border-b border-secondary/5"
						>
							<h3 class="font-bold text-lg">
								Información de la cuenta
							</h3>
							<button
								class="text-primary font-bold text-xs uppercase tracking-widest hover:underline"
								>Editar</button
							>
						</div>

						<div class="space-y-8">
							<div class="grid grid-cols-2 gap-4">
								<div>
									<label
										class="block text-[10px] uppercase font-bold tracking-widest text-secondary/30 mb-1"
										>Nombre</label
									>
									<p class="font-bold">{user.name}</p>
								</div>
								<div>
									<label
										class="block text-[10px] uppercase font-bold tracking-widest text-secondary/30 mb-1"
										>Email</label
									>
									<p class="font-bold">{user.email}</p>
								</div>
							</div>

							<div>
								<h4 class="font-bold text-sm mb-4">
									Pedidos recientes
								</h4>
								<div
									class="bg-accent/30 rounded-2xl p-8 text-center text-secondary/30"
								>
									<svg
										xmlns="http://www.w3.org/2000/svg"
										width="32"
										height="32"
										viewBox="0 0 24 24"
										fill="none"
										stroke="currentColor"
										stroke-width="2"
										stroke-linecap="round"
										stroke-linejoin="round"
										class="mx-auto mb-4 opacity-20"
										><path
											d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"
										></path><path d="M3 6h18"></path><path
											d="M16 10a4 4 0 0 1-8 0"
										></path></svg
									>
									<p
										class="text-xs font-bold uppercase tracking-widest"
									>
										Aún no realizaste ninguna compra
									</p>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="mt-12 text-center">
					<form action="/logout" method="POST">
						<button
							type="submit"
							class="text-secondary/40 font-bold uppercase tracking-widest text-xs hover:text-primary transition-colors"
						>
							Cerrar Sesión
						</button>
					</form>
				</div>
			</div>
		</div>
	</section>
</Layout>
