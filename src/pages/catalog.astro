---
export const prerender = false;
import Layout from "@/layouts/Layout.astro";
import ProductCard from "@/components/catalog/ProductCard.astro";
import PageHeader from "@/components/web/common/PageHeader.astro";
import { ProductService } from "@/services/productService";
import { CategoryService } from "@/services/categoryService";

const categoryId = Astro.url.searchParams.get("category") || "";
const page = Number(Astro.url.searchParams.get("page") || 1);
const limit = 12;

const { products: rawProducts, total } = await ProductService.getAll({
	page,
	limit,
	categoryId,
});
const categories = await CategoryService.getAll();

const allProducts = rawProducts.filter(p => p.status !== 'inactive');
const totalPages = Math.ceil(total / limit);
---

<Layout
	title="Catálogo de Productos"
	description="Explorá nuestra selección completa de réplicas oficiales CAT Caterpillar a escala. Modelos coleccionables de maquinaria pesada en escalas 1:16, 1:24, 1:25, 1:50 y 1:87."
	image="/images/index/P1011358.webp"
>
	<PageHeader
		title="Nuestro Catálogo"
		subtitle="Explorá nuestra selección de productos de maquinaria pesada Caterpillar a escala."
	/>

	<section class="section-padding bg-accent/20 min-h-[60vh]">
		<div class="container-custom">
			<!-- Dynamic Filters -->
			<div class="flex flex-wrap gap-4 mb-16 items-center">
				<span
					class="text-xs font-bold uppercase tracking-widest text-secondary/40 mr-4"
					>Filtrar por:</span
				>
				<a
					href="/catalog"
					class={`px-6 py-2 rounded-full text-sm font-bold transition-all duration-300 border ${
						!categoryId
							? "bg-primary border-primary text-white shadow-lg shadow-primary/20"
							: "bg-white border-secondary/10 text-secondary/60 hover:border-primary/40 hover:text-primary"
					}`}
				>
					Todos
				</a>
				{
					categories.map((cat) => (
						<a
							href={`/catalog?category=${cat.id}`}
							class={`px-6 py-2 rounded-full text-sm font-bold transition-all duration-300 border ${
								categoryId === String(cat.id)
									? "bg-primary border-primary text-white shadow-lg shadow-primary/20"
									: "bg-white border-secondary/10 text-secondary/60 hover:border-primary/40 hover:text-primary"
							}`}
						>
							{cat.name}
						</a>
					))
				}
			</div>

			<!-- Grid -->
			<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
				{
					allProducts.map((p) => (
						<ProductCard
							id={p.id!}
							title={p.title}
							category={p.category_name || "Sin categoría"}
							image={p.main_image}
							price={p.price}
							status={p.status}
						/>
					))
				}
			</div>

			{
				allProducts.length === 0 && (
					<div class="py-24 text-center">
						<p class="text-secondary/40 font-bold">
							No se encontraron productos en esta categoría.
						</p>
						<a
							href="/catalog"
							class="text-primary font-black mt-4 inline-block hover:underline"
						>
							Ver todos los productos
						</a>
					</div>
				)
			}

			<!-- Pagination -->
			{
				totalPages > 1 && (
					<div class="mt-20 flex justify-center items-center gap-4">
						<a
							href={
								page > 1
									? `/catalog?page=${page - 1}${categoryId ? `&category=${categoryId}` : ""}`
									: "#"
							}
							class={`w-10 h-10 rounded-lg flex items-center justify-center bg-white border border-secondary/10 text-secondary/60 transition-colors ${page === 1 ? "opacity-30 cursor-not-allowed pointer-events-none" : "hover:border-primary hover:text-primary cursor-pointer"}`}
						>
							<svg
								xmlns="http://www.w3.org/2000/svg"
								width="20"
								height="20"
								viewBox="0 0 24 24"
								fill="none"
								stroke="currentColor"
								stroke-width="2"
								stroke-linecap="round"
								stroke-linejoin="round"
							>
								<path d="m15 18-6-6 6-6" />
							</svg>
						</a>

						{Array.from(
							{ length: totalPages },
							(_, i) => i + 1,
						).map((p) => (
							<a
								href={`/catalog?page=${p}${categoryId ? `&category=${categoryId}` : ""}`}
								class={`w-10 h-10 rounded-lg flex items-center justify-center font-bold transition-all ${
									page === p
										? "bg-primary text-white shadow-lg shadow-primary/20"
										: "bg-white border border-secondary/10 text-secondary/60 hover:border-primary hover:text-primary"
								}`}
							>
								{p}
							</a>
						))}

						<a
							href={
								page < totalPages
									? `/catalog?page=${page + 1}${categoryId ? `&category=${categoryId}` : ""}`
									: "#"
							}
							class={`w-10 h-10 rounded-lg flex items-center justify-center bg-white border border-secondary/10 text-secondary/60 transition-colors ${page === totalPages ? "opacity-30 cursor-not-allowed pointer-events-none" : "hover:border-primary hover:text-primary cursor-pointer"}`}
						>
							<svg
								xmlns="http://www.w3.org/2000/svg"
								width="20"
								height="20"
								viewBox="0 0 24 24"
								fill="none"
								stroke="currentColor"
								stroke-width="2"
								stroke-linecap="round"
								stroke-linejoin="round"
								class="rotate-180"
							>
								<path d="m15 18-6-6 6-6" />
							</svg>
						</a>
					</div>
				)
			}
		</div>
	</section>
</Layout>
