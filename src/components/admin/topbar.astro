---
interface Props {
	user: {
		name: string;
		role: string;
	};
}

const { user } = Astro.props;
---

<header
	class="h-14 bg-white border-b border-secondary/5 px-4 lg:pr-8 lg:pl-4 flex items-center justify-between sticky top-0 z-40 transition-all duration-300"
>
	<div class="flex items-center gap-4">
		<button
			id="sidebar-toggle"
			class="size-10 flex items-center justify-center bg-accent/30 rounded-xl text-secondary hover:bg-primary/10 hover:text-primary transition-all cursor-pointer shadow-sm group"
		>
			<svg
				xmlns="http://www.w3.org/2000/svg"
				width="24"
				height="24"
				viewBox="0 0 24 24"
				fill="none"
				stroke="currentColor"
				stroke-width="1.5"
				stroke-linecap="round"
				stroke-linejoin="round"
				class="transition-transform group-active:scale-90"
				><line x1="3" y1="12" x2="21" y2="12"></line><line
					x1="3"
					y1="6"
					x2="21"
					y2="6"></line><line x1="3" y1="18" x2="21" y2="18"
				></line></svg
			>
		</button>
	</div>

	<div class="flex items-center gap-3 lg:gap-6">
		<!-- Notifications Bell -->
		<div class="relative" id="notifications-container">
			<button
				id="notifications-toggle"
				class="relative w-10 h-10 flex items-center justify-center bg-accent/30 rounded-full text-secondary/60 hover:text-primary transition-colors cursor-pointer"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					width="16"
					height="16"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2.5"
					stroke-linecap="round"
					stroke-linejoin="round"
					><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"
					></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg
				>
				<span
					id="notifications-badge"
					class="absolute -top-0.5 -right-0.5 min-w-5 h-5 px-1 bg-primary text-white text-[10px] font-bold rounded-full flex items-center justify-center hidden"
				></span>
			</button>

			<!-- Notifications Dropdown -->
			<div
				id="notifications-dropdown"
				class="absolute right-0 top-12 bg-white rounded-xl shadow-xl border border-secondary/10 opacity-0 invisible translate-y-2 transition-all duration-200 z-50"
				style="width: 280px"
			>
				<div class="p-3 border-b border-secondary/10 flex items-center justify-between">
					<h3 class="font-bold text-secondary text-sm">Notificaciones</h3>
					<button
						id="mark-all-read"
						class="text-xs text-primary hover:underline cursor-pointer"
					>
						Marcar todas como le√≠das
					</button>
				</div>
				<div id="notifications-list" class="max-h-80 overflow-y-auto">
					<div class="p-4 text-center text-secondary/50 text-sm">
						Cargando...
					</div>
				</div>
				<div class="p-2 border-t border-secondary/10">
					<a
						href="/admin/notifications"
						class="block text-center text-xs text-primary hover:underline py-1"
					>
						Ver todas las notificaciones
					</a>
				</div>
			</div>
		</div>

		<div class="flex items-center gap-3 md:pl-6 md:border-l border-secondary/5">
			<div class="text-right hidden md:block">
				<p class="text-sm font-bold leading-none mb-1">{user.name}</p>
				<p
					class="text-[10px] font-bold uppercase tracking-widest text-primary"
				>
					Admin
				</p>
			</div>
			<div
				class="w-10 h-10 bg-secondary rounded-xl flex items-center justify-center text-white font-black shadow-lg shadow-secondary/10"
			>
				{user.name.charAt(0).toUpperCase()}
			</div>
		</div>
	</div>
</header>

<script>
	const toggleBtn = document.getElementById("sidebar-toggle");
	toggleBtn?.addEventListener("click", () => {
		window.dispatchEvent(new Event("toggle-sidebar"));
	});

	// Notifications System
	const notificationsToggle = document.getElementById("notifications-toggle");
	const notificationsDropdown = document.getElementById("notifications-dropdown");
	const notificationsBadge = document.getElementById("notifications-badge");
	const notificationsList = document.getElementById("notifications-list");
	const markAllReadBtn = document.getElementById("mark-all-read");

	let isDropdownOpen = false;

	function formatTimeAgo(dateString: string): string {
		const date = new Date(dateString);
		const now = new Date();
		const diffMs = now.getTime() - date.getTime();
		const diffMins = Math.floor(diffMs / 60000);
		const diffHours = Math.floor(diffMins / 60);
		const diffDays = Math.floor(diffHours / 24);

		if (diffMins < 1) return "Ahora";
		if (diffMins < 60) return `Hace ${diffMins} min`;
		if (diffHours < 24) return `Hace ${diffHours}h`;
		return `Hace ${diffDays}d`;
	}

	function getNotificationIcon(type: string): string {
		const icons: Record<string, string> = {
			payment_approved: `<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`,
			new_order: `<svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>`,
			low_stock: `<svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`,
			system: `<svg class="w-5 h-5 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`
		};
		return icons[type] || icons.system;
	}

	async function fetchNotifications() {
		try {
			const res = await fetch("/api/admin/notifications?action=unread");
			if (!res.ok) throw new Error("Error fetching notifications");
			const data = await res.json();
			updateBadge(data.count);
			renderNotifications(data.notifications);
		} catch (error) {
			console.error("Error loading notifications:", error);
			if (notificationsList) {
				notificationsList.innerHTML = `
					<div class="p-4 text-center text-red-500 text-sm">
						Error al cargar notificaciones
					</div>
				`;
			}
		}
	}

	function updateBadge(count: number) {
		if (!notificationsBadge) return;
		if (count > 0) {
			notificationsBadge.textContent = count > 99 ? "99+" : String(count);
			notificationsBadge.classList.remove("hidden");
		} else {
			notificationsBadge.classList.add("hidden");
		}
	}

	function renderNotifications(notifications: any[]) {
		if (!notificationsList) return;

		if (notifications.length === 0) {
			notificationsList.innerHTML = `
				<div class="p-4 text-center text-secondary/50 text-sm">
					No hay notificaciones nuevas
				</div>
			`;
			return;
		}

		notificationsList.innerHTML = notifications
			.map(
				(n) => `
				<div class="notification-item p-3 hover:bg-accent/20 cursor-pointer border-b border-secondary/5 last:border-0 flex gap-3 items-start transition-colors" data-id="${n.id}">
					<div class="flex-shrink-0 mt-0.5">
						${getNotificationIcon(n.type)}
					</div>
					<div class="flex-1 min-w-0">
						<p class="text-sm font-semibold text-secondary truncate">${n.title}</p>
						<p class="text-xs text-secondary/60 line-clamp-2">${n.message}</p>
						<p class="text-[10px] text-secondary/40 mt-1">${formatTimeAgo(n.created_at)}</p>
					</div>
				</div>
			`
			)
			.join("");

		// Add click handlers to mark as read
		document.querySelectorAll(".notification-item").forEach((item) => {
			item.addEventListener("click", async () => {
				const id = item.getAttribute("data-id");
				if (id) {
					await markAsRead(parseInt(id));
					fetchNotifications();
				}
			});
		});
	}

	async function markAsRead(id: number) {
		try {
			await fetch("/api/admin/notifications", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ action: "mark_read", id })
			});
		} catch (error) {
			console.error("Error marking notification as read:", error);
		}
	}

	async function markAllAsRead() {
		try {
			await fetch("/api/admin/notifications", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ action: "mark_all_read" })
			});
			fetchNotifications();
		} catch (error) {
			console.error("Error marking all as read:", error);
		}
	}

	function toggleDropdown() {
		if (!notificationsDropdown) return;
		isDropdownOpen = !isDropdownOpen;
		if (isDropdownOpen) {
			notificationsDropdown.classList.remove("opacity-0", "invisible", "translate-y-2");
			notificationsDropdown.classList.add("opacity-100", "visible", "translate-y-0");
			fetchNotifications();
		} else {
			notificationsDropdown.classList.add("opacity-0", "invisible", "translate-y-2");
			notificationsDropdown.classList.remove("opacity-100", "visible", "translate-y-0");
		}
	}

	// Event listeners
	notificationsToggle?.addEventListener("click", (e) => {
		e.stopPropagation();
		toggleDropdown();
	});

	markAllReadBtn?.addEventListener("click", (e) => {
		e.stopPropagation();
		markAllAsRead();
	});

	// Close dropdown when clicking outside
	document.addEventListener("click", (e) => {
		const container = document.getElementById("notifications-container");
		if (container && !container.contains(e.target as Node) && isDropdownOpen) {
			toggleDropdown();
		}
	});

	// Initial fetch and polling
	fetchNotifications();
	//setInterval(fetchNotifications, 30000); // Poll every 30 seconds
</script>
